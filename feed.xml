<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="https://junoh-kang.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://junoh-kang.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2023-09-04T06:49:10+00:00</updated><id>https://junoh-kang.github.io/feed.xml</id><subtitle></subtitle><entry><title type="html">Diffusion Models in Two Perspectives</title><link href="https://junoh-kang.github.io/blog/2023/dl-Diffusion-Models-in-Two-Perspectives/" rel="alternate" type="text/html" title="Diffusion Models in Two Perspectives"/><published>2023-09-03T00:00:00+00:00</published><updated>2023-09-03T00:00:00+00:00</updated><id>https://junoh-kang.github.io/blog/2023/dl%20:%20Diffusion%20Models%20in%20Two%20Perspectives</id><content type="html" xml:base="https://junoh-kang.github.io/blog/2023/dl-Diffusion-Models-in-Two-Perspectives/"><![CDATA[<h2 id="overview">Overview</h2> <p><strong>DDPM</strong><d-cite key="ho2020denoising"></d-cite> and <strong>Score-Based Model</strong><d-cite key="song2021scorebased"></d-cite> introduce diffusion model as a new paradigm of generative models. Since the concepts of both papers are similar, one might regard <strong>Score-Based Model</strong><d-cite key="song2021scorebased"></d-cite> as only a continuous version of <strong>DDPM</strong><d-cite key="ho2020denoising"></d-cite>. However in my opinion, two papers have slight different views, even their loss functions and implementations are the same.</p> <p>This post mainly explains how formulations and objectives of two papers are different, and how they are related even with the differences.</p> <h4 id="summary-of-the-post">Summary of the post</h4> <ol> <li>The objective of <strong>DDPM</strong><d-cite key="ho2020denoising"></d-cite> is to minimize the surrogate of the negative log-likelihood.</li> <li>The objective of <strong>Score-Based Model</strong><d-cite key="song2021scorebased"></d-cite> is to match marginal distributions of forward SDE and backward SDE/ODE.</li> <li>Even with the differences, both derivations require the score function, differential of the log of the probability density function. The score functions are parametrized by neural networks and both papaers have similar loss functions.</li> </ol> <h2 id="maximizing-log-likelihood">Maximizing Log-Likelihood</h2> <h4 id="forward-diffusion-process">Forward (Diffusion) Process</h4> <p>The forward process is a Markov chain that gradually adds Gaussian noise to the data for $T$ steps with distributions defined as follows: \(\begin{gather} \mathrm{x}_t \perp\mkern-9.5mu\perp \mathrm{x}_{0:t-1}, \\ q_0(\mathrm{x}_0) := \mathrm{P}_{data}(\mathrm{x}_0) ~~\text{and}~~ q_{t|t-1}(\mathrm{x}_t|\mathrm{x}_{t-1}) := \mathcal{N}(\mathrm{x}_t;\sqrt{1-\beta_t}\mathrm{x}_{t-1}, \beta_t \mathrm{I}), \end{gather}\)</p> <p>where \(\{\beta_t\}_{t=1}^T\) are pre-defined constants.</p> <h4 id="backward-denoising-process">Backward (Denoising) Process</h4> <p>The backward process is a Markov chain that gradually denoises perturbed data and it is parametrized by neural networks. From the observation of \(\begin{align} \lim_{\beta_t \rightarrow 0} q_{t-1|t}(\mathrm{x}_{t-1}|\mathrm{x}_{t}) = \mathcal{N}(\mathrm{x}_{t-1}; \cfrac{1}{ \sqrt{1-\beta_t}}(\mathrm{x}_{t} + \beta_t \nabla \log q_t (\mathrm{x}_t)), \beta_t \mathrm{I}), \end{align}\)</p> <details><summary><em>proof.</em></summary> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/pdf/post/20230903_proof-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/pdf/post/20230903_proof-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/pdf/post/20230903_proof-1400.webp"/> <img src="/assets/pdf/post/20230903_proof.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> </details> <p>it is reasonable to parametrize the denoising distribution as Gaussian as long as \(\{\beta_t\}_{t=1}^T\) are infinitesimal. Therefore the bacward process is defined as follows: \(\begin{gather} \mathrm{x}_t \perp\mkern-9.5mu\perp \mathrm{x}_{t+1:T}, \\ p_T(\mathrm{x}_T) := \mathcal{N}(\mathrm{x}_T; \mathrm{0}, \mathrm{I}) ~~\text{and}~~ p_{t-1|t}(\mathrm{x}_{t-1}|\mathrm{x}_{t}) = \mathcal{N}(\mathrm{x}_{t-1}; \cfrac{1}{ \sqrt{1-\beta_t}}(\mathrm{x}_{t} + \beta_t s_\theta(\mathrm{x}_t,t)), \beta_t \mathrm{I}), \end{gather}\)</p> <p>Note that we expect \(s_\theta(\mathrm{x}_t,t)\) to have similar value to \(\nabla\log q_{t}(\mathrm{x}_t)\).</p> <h4 id="minimizing-surrogate-of-negative-log-likelihood">Minimizing Surrogate of Negative Log-Likelihood</h4> <p>The negative log-likelihood of data is \(\begin{align} \mathbb{E}_{\mathrm{x}_0 \sim q} \left[-\log p_0(\mathrm{x}_0)\right] &amp;\leq \mathbb{E}_{\mathrm{x}_0 \sim q} \mathbb{E}_{\mathrm{x}_{1:T|0} \sim q} \left[ \log \cfrac{q_{1:T|0}(\mathrm{x}_{1:T}|\mathrm{x}_{0})}{p_{0:T}(\mathrm{x}_{0:T})} \right]. \end{align}\)</p> <details><summary><em>proof.</em></summary> \[\begin{align*} -\log p_0(\mathrm{x}_0) &amp;= -\log \int p_{0:T}(\mathrm{x}_{0:T}) d\mathrm{x}_{1:T} \\ &amp;= -\log \int q_{1:T|0}(\mathrm{x}_{1:T}|\mathrm{x}_{0}) \cfrac{p_{0:T}(\mathrm{x}_{0:T})}{q_{1:T|0}(\mathrm{x}_{1:T}|\mathrm{x}_{0})} d\mathrm{x}_{1:T} \\ &amp;\leq -\int q_{1:T|0}(\mathrm{x}_{1:T}|\mathrm{x}_{0}) \log \cfrac{p_{0:T}(\mathrm{x}_{0:T})}{q_{1:T|0}(\mathrm{x}_{1:T}|\mathrm{x}_{0})} d\mathrm{x}_{1:T} ~~(\because \text{Jensen})\\ &amp;= \mathbb{E}_{\mathrm{x}_{1:T|0} \sim q} \left[ \log \cfrac{q_{1:T|0}(\mathrm{x}_{1:T}|\mathrm{x}_{0})}{p_{0:T}(\mathrm{x}_{0:T})} \right]. \end{align*}\] </details> <p>Using Markov properties, \(\begin{align} q_{1:T|0}(\mathrm{x}_{1:T} | \mathrm{x}_0) &amp;= q_{T|0}(\mathrm{x}_T | \mathrm{x}_0) \prod_{t=2}^T q_{t-1|t,0}(\mathrm{x}_{t-1} | \mathrm{x}_t, \mathrm{x}_0), \\ p_{T:0}(\mathrm{x}_{T:0}) &amp;= p_{T}(\mathrm{x}_T) \prod_{t=T}^{1} p_{t-1|t}(\mathrm{x}_{t-1}|\mathrm{x}_t). \end{align}\)</p> <details><summary><em>proof.</em></summary> \[\begin{align*} q(\mathrm{x}_{1:T} | \mathrm{x}_0) &amp;= \prod_{t=1}^{T} q(\mathrm{x}_{t}|\mathrm{x}_{0:t-1}) \\ &amp;= \prod_{t=1}^{T} q(\mathrm{x}_{t}|\mathrm{x}_{t-1}) \\ &amp;= q(\mathrm{x}_1|\mathrm{x}_0)\prod_{t=2}^{T} q(\mathrm{x}_{t}|\mathrm{x}_{t-1}, \mathrm{x}_{0}) \\ &amp;= q(\mathrm{x}_1|\mathrm{x}_0)\prod_{t=2}^{T} \frac{q(\mathrm{x}_{t},\mathrm{x}_{t-1}| \mathrm{x}_{0})}{q(\mathrm{x}_{t-1}| \mathrm{x}_{0})} \\ &amp;= q(\mathrm{x}_1|\mathrm{x}_0)\prod_{t=2}^{T} \frac{q(\mathrm{x}_{t}|\mathrm{x}_{0})q(\mathrm{x}_{t-1}| \mathrm{x}_{t},\mathrm{x}_{0})}{q(\mathrm{x}_{t-1}| \mathrm{x}_{0})} \\ &amp;= q(\mathrm{x}_T | \mathrm{x}_0) \prod_{t=2}^T q(\mathrm{x}_{t-1} | \mathrm{x}_t, \mathrm{x}_0), \\ p(\mathrm{x}_{T:0}) &amp;= p(\mathrm{x}_T) \prod_{t=T}^{1} p(\mathrm{x}_{t-1}|\mathrm{x}_{T:t})\\ &amp;= p(\mathrm{x}_T) \prod_{t=T}^{1} p(\mathrm{x}_{t-1}|\mathrm{x}_t). \end{align*}\] </details> <p>Therefore, the surrogate of negative log-likelihood becomes \(\begin{align} D_{KL}(q_{T|0}(\mathrm{x}_T|\mathrm{x}_0) || p(\mathrm{x}_T)) + \mathbb{E}_q\left[-\log p_{0|1}(\mathrm{x}_0|\mathrm{x}_1)\right] + \sum_{t=2}^T D_{KL}(q_{t-1|t,0}(\mathrm{x}_{t-1} | \mathrm{x}_t, \mathrm{x}_0) || p_{t-1|t}(\mathrm{x}_{t-1}|\mathrm{x}_t)). \end{align}\)</p> <p>The surrogate of negative log-likelihood can be explictly expressed using \(\begin{align} &amp;p_{t-1|t}(\mathrm{x}_{t-1}|\mathrm{x}_{t}) = \mathcal{N}(\mathrm{x}_{t-1}; \cfrac{1}{ \sqrt{1-\beta_t}}(\mathrm{x}_{t} + \beta_t s_\theta(\mathrm{x}_t,t)), \beta_t \mathrm{I}), \\ &amp;q_{t-1|t}(\mathrm{x}_{t-1}|\mathrm{x}_{t}, \mathrm{x}_{0}) = \mathcal{N}(\mathrm{x}_{t-1}; \cfrac{1}{ \sqrt{1-\beta_t}}(\mathrm{x}_{t} + \beta_t \nabla \log q_{t|0} (\mathrm{x}_t|\mathrm{x}_{0})), \frac{1-\bar\alpha_{t-1}}{1-\bar\alpha_t}\beta_t \mathrm{I}), \end{align}\)</p> <p>where \(\bar\alpha_t = \prod_{s=1}^t (1-\beta_s)\).</p> <p>Finally, the objective function becomes \(\begin{align} \sum_{t=1}^T \mathbb{E}_{\mathrm{x}_0}\mathbb{E}_{\mathrm{x}_{t}|\mathrm{x}_{0}} \left[ \lambda_t ||s_\theta(\mathrm{x}_t,t) - \nabla \log q_{t|0}(\mathrm{x}_t|\mathrm{x}_0)||_2^2 \right], \end{align}\)</p> <p>where \(\lambda_t\) are some constants. </p> <h2 id="matching-marginal-distributions">Matching Marginal Distributions</h2> <h4 id="forward-sde">Forward SDE</h4> <p>For pre-defined function \(f:\mathbb{R}^{h\times w \times 3}\times \mathbb{R} \rightarrow \mathbb{R}^{h\times w \times 3}\) and \(g:\mathbb{R} \rightarrow \mathbb{R}\), a forward SDE perturbs the data with Gaussian noise by \(\begin{align} d\mathrm{x}_t = f(\mathrm{x}_t,t)dt + g(t)d\mathrm{w}_t, ~~\text{and}~~ \mathrm{x}_0 \sim \mathrm{P}_{data}, \end{align}\)</p> <p>where \(\mathrm{w}_t\) is Brownian process.</p> <p>If \(\{\mathrm{x}_t\}_{t=0}^T\) is a solution of the forward SDE, it can be treated as a sample from the joint distribution \(\{p_t\}_{t=0}^T\). However, learning joint distribution is difficult and our interest is only \(\mathrm{x}_0\), not \(\{\mathrm{x}_t\}_{t=0}^T\). Therefore, it suffices to consider weakened objective, learning how marginal distributions evolve as \(t\) changes. The evolution of the marginal distributions is goverened by the <strong>Fokker-Plank equation</strong>: \(\begin{align} \partial_t p_t = - \nabla_x (f \cdot p_t ) + \frac{1}{2} \mathrm{tr}(g^T ~\nabla_x^2p_t~ g). \end{align}\)</p> <h4 id="backward-sdeode">Backward SDE/ODE</h4> <p>Following backward SDE and ODE are known to have the same marginal distributions: \(\begin{align} &amp;d\mathrm{x}_t = \left[ f(\mathrm{x}_t,t)dt - g^2(t) \nabla \log p_t(\mathrm{x}_t) \right]dt + g(t)d\bar{\mathrm{w}}_t , ~~\text{and}~~ \mathrm{x}_T \sim \mathcal{N}(\mathrm{0}, \mathrm{I}), \\ &amp;d\mathrm{x}_t = \left[ f(\mathrm{x}_t,t)dt - \frac{1}{2} g^2(t) \nabla \log p_t(\mathrm{x}_t) \right]dt , ~~\text{and}~~ \mathrm{x}_T \sim \mathcal{N}(\mathrm{0}, \mathrm{I}), \end{align}\)</p> <p>where \(\bar{\mathrm{w}}_t\) is the reverse-time Brownian motion. </p> <p>Since \(f(\cdot, \cdot)\) and \(g(\cdot)\) are known, the only unknown component in backward SDE/ODE is \(\nabla \log p_t (\cdot)\) which is also known as a score function. The score function is parametrized by neural network, \(s_\theta(\mathrm{x}_t,t)\).</p> <h4 id="learning-score-function">Learning Score Function</h4> <p>Since we parametrized the score function with the neural network, we can consider a loss function of \(\begin{align} \int_{0}^{T} \lambda_t \mathbb{E}_{\mathrm{x}_t} \left[ ||s_\theta(\mathrm{x}_t,t) - \nabla \log p_t(\mathrm{x}_t)||_2^2 \right] dt, \end{align}\)</p> <p>where \(\lambda_t\) are some constants. Note that \(\nabla\log p_t(\mathrm{x}_t)\) is intractable and with some tricks, the loss function changes into tractable form: \(\begin{align} \int_{0}^{T} \lambda_t \mathbb{E}_{\mathrm{x}_0}\mathbb{E}_{\mathrm{x}_{t}|\mathrm{x}_{0}} \left[ ||s_\theta(\mathrm{x}_t,t) - \nabla \log p_{t|0}(\mathrm{x}_t|\mathrm{x}_0)||_2^2 \right] dt. \end{align}\)</p>]]></content><author><name>Junoh Kang</name></author><category term="deep-learning"/><category term="survey"/><summary type="html"><![CDATA[Overview]]></summary></entry></feed>